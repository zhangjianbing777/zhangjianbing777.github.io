<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="在谷歌上百度"><title>Spring Boot 2.0深度实践：理解自动装配 | 在谷歌上百度</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '1b809372ac65144e503257302064db9a';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring Boot 2.0深度实践：理解自动装配</h1><a id="logo" href="/.">在谷歌上百度</a><p class="description">但行好事，莫问前程</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a><a href="/comments/"><i class="fa fa-comments"> 留言</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Spring Boot 2.0深度实践：理解自动装配</h1><div class="post-meta">Apr 14, 2019<span> | </span><span class="category"><a href="/categories/boot/">boot</a></span></div><a class="disqus-comment-count" data-disqus-identifier="boot/boot-autoconfig.html" href="/boot/boot-autoconfig.html#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Framework-手动装配"><span class="toc-number">1.</span> <span class="toc-text">Spring Framework 手动装配</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Framework-Enable模块装配"><span class="toc-number">1.1.</span> <span class="toc-text">Spring Framework @Enable模块装配</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Framework-条件装配-Profile"><span class="toc-number">1.2.</span> <span class="toc-text">Spring Framework 条件装配 @Profile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Framework-条件装配-Conditional"><span class="toc-number">1.3.</span> <span class="toc-text">Spring Framework 条件装配 @Conditional</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ImportBeanDefinitionRegistrar"><span class="toc-number">1.4.</span> <span class="toc-text">ImportBeanDefinitionRegistrar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Component的派生性"><span class="toc-number">1.5.</span> <span class="toc-text">@Component的派生性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Boot-自动装配"><span class="toc-number">2.</span> <span class="toc-text">Spring Boot 自动装配</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBootApplication注解语义"><span class="toc-number">2.1.</span> <span class="toc-text">@SpringBootApplication注解语义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBootApplication标注非引导类"><span class="toc-number">2.2.</span> <span class="toc-text">@SpringBootApplication标注非引导类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#理解自动配置机制"><span class="toc-number">2.3.</span> <span class="toc-text">理解自动配置机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建自动配置类"><span class="toc-number">2.4.</span> <span class="toc-text">创建自动配置类</span></a></li></ol></li></ol></div></div><div class="post-content"><p>说起自动装配，在Spring中并不是什么新鲜事儿，只不过由于SpringBoot的崛起，让它的作用更加强大了起来。</p>
<a id="more"></a>

<h1 id="Spring-Framework-手动装配"><a href="#Spring-Framework-手动装配" class="headerlink" title="Spring Framework 手动装配"></a>Spring Framework 手动装配</h1><h2 id="Spring-Framework-Enable模块装配"><a href="#Spring-Framework-Enable模块装配" class="headerlink" title="Spring Framework @Enable模块装配"></a>Spring Framework @Enable模块装配</h2><ul>
<li>定义：具备相同领域的功能组件集合，组合所形成一个独立的单元</li>
<li>举例：@EnableWebMvc、@EnableAutoConfiguration</li>
<li>实现：注解方式，编程方式</li>
</ul>
<blockquote>
<p>举例：激活Enable模块(注解方式)</p>
</blockquote>
<ul>
<li>配置类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>: HelloWorldConfiguration</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/4/22</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@From</span> https://www.zhangjianbing.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello Ryan"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ImportSelector接口的实现类</li>
</ul>
<p>将上面的配置类导入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>: HelloWorldImportSelector</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/4/22</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@From</span> https://www.zhangjianbing.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">"com.zhangjianbing.autoconfig.config.HelloWorldConfiguration"</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建激活自动装配注解</li>
</ul>
<p>将ImportSelector接口的实现类通过@Import导入进来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(HelloWorldImportSelector<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableHelloWorld</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>引导类</li>
</ul>
<p>将激活自动装配的注解标注在类上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>: HelloWorldBootStrap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/4/22</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@From</span> https://www.zhangjianbing.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableHelloWorld</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldBootStrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">new</span> SpringApplicationBuilder(HelloWorldBootStrap<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">web</span>(<span class="title">WebApplicationType</span>.<span class="title">NONE</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">run</span>(<span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">        String helloWorld = context.getBean(<span class="string">"helloWorld"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(helloWorld);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样通过注解的方式，间接的将名字为 <code>helloWorld</code> 的类导入到了容器中。</p>
</blockquote>
<h2 id="Spring-Framework-条件装配-Profile"><a href="#Spring-Framework-条件装配-Profile" class="headerlink" title="Spring Framework 条件装配 @Profile"></a>Spring Framework 条件装配 @Profile</h2><ul>
<li>计算服务接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICalculatorService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">sum</span><span class="params">(Integer... i)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建java7条件</li>
</ul>
<p>标注 <code>@Profile(&quot;java7&quot;)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"java7"</span>)</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Java7ForImpl</span> <span class="keyword">implements</span> <span class="title">ICalculatorService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  Integer <span class="title">sum</span><span class="params">(Integer... values)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"java7---------执行"</span>);</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">            sum += values[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Java7ForImpl i = <span class="keyword">new</span> Java7ForImpl();</span><br><span class="line">        Integer sum = i.sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建java8条件</li>
</ul>
<p>标注 <code>@Profile(&quot;java8&quot;)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"java8"</span>)</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Java8ForImpl</span> <span class="keyword">implements</span> <span class="title">ICalculatorService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">sum</span><span class="params">(Integer... values)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"java8---------执行"</span>);</span><br><span class="line">        <span class="keyword">int</span> sum = Stream.of(values).reduce(<span class="number">0</span>, Integer::sum);</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Java8ForImpl i = <span class="keyword">new</span> Java8ForImpl();</span><br><span class="line">        Integer sum = i.sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>计算服务引导类</li>
</ul>
<p>在改变 <code>.profiles(&quot;java7&quot;)</code>  的时候，符合条件的Bean才会被注入到容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.zhangjianbing.autoconfig.conditionconfig.profileconfig"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileBootStrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">new</span> SpringApplicationBuilder(ProfileBootStrap<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">web</span>(<span class="title">WebApplicationType</span>.<span class="title">NONE</span>)</span></span><br><span class="line">                .profiles("java7")</span><br><span class="line">                .run(args);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Java7ForImpl java7ForImpl = context.getBean("java7ForImpl", Java7ForImpl.class);</span></span><br><span class="line"><span class="comment">//        Integer sum = java7ForImpl.sum(1, 2, 3);</span></span><br><span class="line"><span class="comment">//        System.out.println(sum);</span></span><br><span class="line"><span class="comment">//        System.out.println(java7ForImpl);</span></span><br><span class="line"></span><br><span class="line">        ICalculatorService calculator = context.getBean(ICalculatorService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Integer sum = calculator.sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">        System.out.println(sum);</span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Framework-条件装配-Conditional"><a href="#Spring-Framework-条件装配-Conditional" class="headerlink" title="Spring Framework 条件装配 @Conditional"></a>Spring Framework 条件装配 @Conditional</h2><blockquote>
<p>在Spring Boot的AutoConfiguration中，使用了很多的@Conditional注解，比如自动装配Mvc</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span>(type = Type.SERVLET)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Servlet<span class="class">.<span class="keyword">class</span>, <span class="title">DispatcherServlet</span>.<span class="title">class</span>, <span class="title">WebMvcConfigurer</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span>(<span class="title">WebMvcConfigurationSupport</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureOrder</span>(<span class="title">Ordered</span>.<span class="title">HIGHEST_PRECEDENCE</span> + 10)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(</span>&#123; DispatcherServletAutoConfiguration<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">		<span class="title">ValidationAutoConfiguration</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">WebMvcAutoConfiguration</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中 <code>@ConditionalOnWebApplication(type = Type.SERVLET)</code> 是 <code>@Conditional</code> 的其中一个”派生”注解，点进去一看究竟。 </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Conditional</span>(OnWebApplicationCondition<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">ConditionalOnWebApplication</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>OnWebApplicationCondition类相当于判断条件，它最终实现的是Condition接口。我们可以仿造它来自己实现编程式的条件装配。</p>
</blockquote>
<ul>
<li>定义判断条件注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Conditional</span>(OnSystemCondition<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">ConditionalOnSystem</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>编辑条件判断类OnSystemCondition</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 装载Bean条件判断实现类 &#123;<span class="doctag">@link</span> Condition&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan</span></span><br><span class="line"><span class="comment"> * time 2019/4/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnSystemCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext conditionContext, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取注解信息</span></span><br><span class="line">        Map&lt;String, Object&gt; attributes = metadata.getAnnotationAttributes(ConditionalOnSystem<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        String name = String.valueOf(attributes.get(<span class="string">"name"</span>));</span><br><span class="line">        String value = String.valueOf(attributes.get(<span class="string">"value"</span>));</span><br><span class="line">      	<span class="comment">// 获取系统名称</span></span><br><span class="line">        String systemname = System.getProperties().getProperty(name);</span><br><span class="line">        <span class="keyword">return</span> systemname.equals(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>编写启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionBootStrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnSystem</span>(name = <span class="string">"user.name"</span>,value = <span class="string">"Ryan_Zhang"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">new</span> SpringApplicationBuilder(ConditionBootStrap<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">web</span>(<span class="title">WebApplicationType</span>.<span class="title">NONE</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">run</span>(<span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 当条件成立的时候，会将User注入到容器中，否则就会报异常</span></span><br><span class="line">        User user = context.getBean(<span class="string">"user"</span>, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ImportBeanDefinitionRegistrar"><a href="#ImportBeanDefinitionRegistrar" class="headerlink" title="ImportBeanDefinitionRegistrar"></a>ImportBeanDefinitionRegistrar</h2><blockquote>
<p>此接口的主要作用是根据条件向容器中导入Bean的定义信息。</p>
</blockquote>
<ul>
<li><p>两个参数：</p>
<ul>
<li>AnnotationMetadata：注解的元信息</li>
<li>BeanDefinitionRegistry：Bean的定义信息</li>
</ul>
</li>
<li><p>定义实现类</p>
</li>
</ul>
<blockquote>
<p>如果容器中存在Pig和Fish的定义信息，就向容器中注入User的定义信息，在利用beanDefinitionRegistry注入Bean定义信息的时候，需要借助RootBeanDefinition来包装一下。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125; 实现类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan</span></span><br><span class="line"><span class="comment"> * time 2019/4/28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata annotationMetadata, BeanDefinitionRegistry beanDefinitionRegistry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> a = beanDefinitionRegistry.containsBeanDefinition(Pig<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="keyword">boolean</span> b = beanDefinitionRegistry.containsBeanDefinition(Fish<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="keyword">if</span> (a &amp;&amp; b) &#123;</span><br><span class="line">            <span class="comment">// 如果容器中存在 pig 和 fish 的定义信息，就向容器中注入 User 的定义信息</span></span><br><span class="line">            RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition(User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            beanDefinitionRegistry.registerBeanDefinition(<span class="string">"user"</span>, beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>扫描配置类</li>
</ul>
<blockquote>
<p>利用@Import注解，向容器中注册Bean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan</span></span><br><span class="line"><span class="comment"> * time 2019/4/28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;Pig<span class="class">.<span class="keyword">class</span>, <span class="title">Fish</span>.<span class="title">class</span>, <span class="title">HelloWorldImportBeanDefinitionRegistrar</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ImportBeanDefinitionRegistrarConfig</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan</span></span><br><span class="line"><span class="comment"> * time 2019/4/28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.zhangjianbing.autoconfig.conditionconfig.importbeandefinitionregistrarconfig"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImportBeanDefinitionRegistrarBootStrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">new</span> SpringApplicationBuilder(ImportBeanDefinitionRegistrarBootStrap<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">web</span>(<span class="title">WebApplicationType</span>.<span class="title">NONE</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">run</span>(<span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取Bean的定义信息</span></span><br><span class="line">        String[] beanDefinitionNames = context.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String str : beanDefinitionNames) &#123;</span><br><span class="line">            System.out.println(<span class="string">"====== "</span> + str);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>打印结果</li>
</ul>
<blockquote>
<p>因为容器中存在了Pig和Fish的定义信息，所以将User注入了进去。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">====== org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">====== org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">====== org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">====== org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">====== org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">====== org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">====== importBeanDefinitionRegistrarBootStrap</span><br><span class="line">====== org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory</span><br><span class="line">====== importBeanDefinitionRegistrarConfig</span><br><span class="line">====== com.zhangjianbing.autoconfig.entity.Pig</span><br><span class="line">====== com.zhangjianbing.autoconfig.entity.Fish</span><br><span class="line">====== user</span><br></pre></td></tr></table></figure>



<h2 id="Component的派生性"><a href="#Component的派生性" class="headerlink" title="@Component的派生性"></a>@Component的派生性</h2><p>在 <code>com.zhangjianbing.autoconfig.repository</code> 包下创建注解：</p>
<ul>
<li>新建Component的派生注解，FirstLevelRepository注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: 自定义一级注解 &#123;<span class="doctag">@link</span> Repository <span class="doctag">@Repository</span>&#125;</span></span><br><span class="line"><span class="comment"> * Repository的派生性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Ryan Zhang</span></span><br><span class="line"><span class="comment"> * Date: 2019/4/16</span></span><br><span class="line"><span class="comment"> * From: https://www.zhangjianbing.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FirstLevelRepository &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建FirstLevelRepository的派生注解，SecondLevelRepository注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: 自定义二级注解 &#123;<span class="doctag">@link</span> Repository <span class="doctag">@Repository</span>&#125;</span></span><br><span class="line"><span class="comment"> * Repository的派生性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Ryan Zhang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@FirstLevelRepository</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SecondLevelRepository &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面三者的关系：</p>
<ul>
<li>@Component<ul>
<li>@FirstLevelRepository<ul>
<li>@SecondLevelRepository</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>它们是层级关系，但效果是一样的都是容器的一个组件，测试如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>: RepositoryBootStrap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: Repository引导类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/4/16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@From</span> https://www.zhangjianbing.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.zhangjianbing.autoconfig.repository"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepositoryBootStrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">new</span> SpringApplicationBuilder(RepositoryBootStrap<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">web</span>(<span class="title">WebApplicationType</span>.<span class="title">NONE</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">run</span>(<span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">        MyFirstRepository myFirstRepository = context.getBean(<span class="string">"myFirstRepository"</span>, MyFirstRepository<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(<span class="string">"=================&gt; "</span> + myFirstRepository);</span><br><span class="line"></span><br><span class="line">        MySecondLevelRepository secondLevelRepository = context.getBean(<span class="string">"mySecondLevelRepository"</span>, MySecondLevelRepository<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(<span class="string">"=================&gt; "</span> + secondLevelRepository);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭对象</span></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Spring-Boot-自动装配"><a href="#Spring-Boot-自动装配" class="headerlink" title="Spring Boot 自动装配"></a>Spring Boot 自动装配</h1><h2 id="SpringBootApplication注解语义"><a href="#SpringBootApplication注解语义" class="headerlink" title="@SpringBootApplication注解语义"></a>@SpringBootApplication注解语义</h2><blockquote>
<p><code>@SpringBootApplication</code> the same as <code>@Configuration</code> <code>@EnableAutoConfiguration</code> <code>@CompnentScan</code> , 并且它们均使用默认的属性，以下举例说明：</p>
</blockquote>
<ul>
<li>原本的BootStrap</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan</span></span><br><span class="line"><span class="comment"> * time 2019/4/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AutoConfigApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台打印的日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Connected to the target VM, address: <span class="string">'127.0.0.1:54587'</span>, transport: <span class="string">'socket'</span></span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___<span class="string">'_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="string">( ( )\___ | '</span>_ | <span class="string">'_| | '</span>_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  <span class="string">'  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="string"> =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="string"> :: Spring Boot ::        (v2.0.0.RELEASE)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2019-04-21 16:07:52.441  INFO 3123 --- [           main] c.z.autoconfig.AutoConfigApplication     : Starting AutoConfigApplication on dadabingdeMBP.lan with PID 3123 (/Users/zhangjianbing/springboot-deep-practice/springboot-autoconfig-chapter/target/classes started by zhangjianbing in /Users/zhangjianbing/springboot-deep-practice)</span></span><br><span class="line"><span class="string">2019-04-21 16:07:52.447  INFO 3123 --- [           main] c.z.autoconfig.AutoConfigApplication     : No active profile set, falling back to default profiles: default</span></span><br><span class="line"><span class="string">2019-04-21 16:07:52.527  INFO 3123 --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@6e2aa843: startup date [Sun Apr 21 16:07:52 CST 2019]; root of context hierarchy</span></span><br><span class="line"><span class="string">2019-04-21 16:07:53.612  INFO 3123 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup</span></span><br><span class="line"><span class="string">2019-04-21 16:07:53.628  INFO 3123 --- [           main] c.z.autoconfig.AutoConfigApplication     : Started AutoConfigApplication in 1.629 seconds (JVM running for 3.469)</span></span><br><span class="line"><span class="string">2019-04-21 16:07:53.632  INFO 3123 --- [       Thread-6] s.c.a.AnnotationConfigApplicationContext : Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@6e2aa843: startup date [Sun Apr 21 16:07:52 CST 2019]; root of context hierarchy</span></span><br><span class="line"><span class="string">2019-04-21 16:07:53.634  INFO 3123 --- [       Thread-6]Disconnected from the target VM, address: '</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">54587</span><span class="string">', transport: '</span>socket<span class="string">'</span></span><br><span class="line"><span class="string"> o.s.j.e.a.AnnotationMBeanExporter        : Unregistering JMX-exposed beans on shutdown</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>替换三个注解后的BootStrap</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan</span></span><br><span class="line"><span class="comment"> * time 2019/4/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AutoConfigApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台打印日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Connected to the target VM, address: <span class="string">'127.0.0.1:54630'</span>, transport: <span class="string">'socket'</span></span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___<span class="string">'_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="string">( ( )\___ | '</span>_ | <span class="string">'_| | '</span>_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  <span class="string">'  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="string"> =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="string"> :: Spring Boot ::        (v2.0.0.RELEASE)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2019-04-21 16:11:21.017  INFO 3193 --- [           main] c.z.autoconfig.AutoConfigApplication     : Starting AutoConfigApplication on dadabingdeMBP.lan with PID 3193 (/Users/zhangjianbing/springboot-deep-practice/springboot-autoconfig-chapter/target/classes started by zhangjianbing in /Users/zhangjianbing/springboot-deep-practice)</span></span><br><span class="line"><span class="string">2019-04-21 16:11:21.023  INFO 3193 --- [           main] c.z.autoconfig.AutoConfigApplication     : No active profile set, falling back to default profiles: default</span></span><br><span class="line"><span class="string">2019-04-21 16:11:21.126  INFO 3193 --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@5f20155b: startup date [Sun Apr 21 16:11:21 CST 2019]; root of context hierarchy</span></span><br><span class="line"><span class="string">2019-04-21 16:11:22.138  INFO 3193 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup</span></span><br><span class="line"><span class="string">2019-04-21 16:11:22.150  INFO 3193 --- [           main] c.z.autoconfig.AutoConfigApplication     : Started AutoConfigApplication in 1.761 seconds (JVM running for 2.639)</span></span><br><span class="line"><span class="string">2019-04-21 16:11:22.152  INFO 3193 --- [       Thread-6] s.c.a.AnnotationConfigApplicationContext : Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@5f20155b: startup date [Sun Apr 21 16:11:21 CST 2019]; root of context hierarchy</span></span><br><span class="line"><span class="string">2019-04-21 16:11:22.154  INFO 3193 --- [       Thread-6] o.s.j.e.a.AnnotationMBeanExporter        : Unregistering JMX-exposed beans on shutdown</span></span><br><span class="line"><span class="string">Disconnected from the target VM, address: '</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">54630</span><span class="string">', transport: '</span>socket<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上运行的结果看似一样，但实际情况并非如此，以上Spring Boot 2.0 官方文档上的描述基本上与Spring Boot 1.3 中没有差别。可以参考1.3的官方文档：<a href="https://docs.spring.io/spring-boot/docs/1.3.x/reference/htmlsingle/#using-boot-using-springbootapplication-annotation" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/1.3.x/reference/htmlsingle/#using-boot-using-springbootapplication-annotation</a></p>
</blockquote>
<ul>
<li>2.0中的 <code>@SpringBootApplication</code> 类是这样的：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(excludeFilters = &#123;</span><br><span class="line">		<span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = TypeExcludeFilter<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">		@<span class="title">Filter</span>(<span class="title">type</span> </span>= FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter<span class="class">.<span class="keyword">class</span>) &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">SpringBootApplication</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>1.3中的<code>@SpringBootApplication</code> 类是这样的：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实际上2.0版本的@SpringBootApplication等价于@SpringBootConfiguration，@EnableAutoConfiguration，@ComponentScan三个注解的组合，不过@ComponentScan并非使用了默认值，而是排除了 <code>TypeExcludeFilter</code> 和 <code>AutoConfigurationExcludeFilter</code> ，<code>TypeExcludeFilter</code>是由Spring boot1.4引入，用来查找BeanFactory中已经注册的TypeExcludeFilter Bean，而后者 <code>AutoConfigurationExcludeFilter</code> 是由Spring Boot1.5开始支持，用于排除其他同时标注了@Configuration和@EnableAutoConfiguration的类。</p>
</blockquote>
<p>对比 Boot 1.3和2.0的官方Doc是看不出来差别的，但实际的代码有所改变，从 Boot 1.4开始，已经不再使用@Configuration来标注启动类，而采用的是@SpringBootConfiguration来标注，不过两者在运行中并无差异，但它们都属于Component组件，这种对象之间的继承关系，称之为 <code>@Component</code> 的派生性，关于派生性会在 <code>走向自动装配</code> 深入介绍。</p>
<ul>
<li><p>Component派生注解</p>
<ul>
<li><p>@SpringBootConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@Configuration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Configuration &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor</span>(annotation = Component<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">	String value() default "";</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因此三者关系如下：</p>
<ul>
<li>@Component<ul>
<li>@Configuration<ul>
<li>@SpringBootConfiguration</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>尽管@ComponentScan仅扫描@Component组件，但是@SpringBootConfiguration是@Component的派生注解，所以也会扫描标注了@SpringBootConfiguration的类。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h2 id="SpringBootApplication标注非引导类"><a href="#SpringBootApplication标注非引导类" class="headerlink" title="@SpringBootApplication标注非引导类"></a>@SpringBootApplication标注非引导类</h2><ul>
<li>配置类，将注解换掉，并且指定扫描的包，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>: WebConfiguration</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/4/21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@From</span> https://www.zhangjianbing.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = &#123;<span class="string">"com.zhangjianbing.autoconfig"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfiguration</span> </span>&#123;</span><br><span class="line">		......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动类将注解全都去掉，并将参数改成配置类，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan</span></span><br><span class="line"><span class="comment"> * time 2019/4/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WebConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Controller如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ryan Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>: UserController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 用户控制类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/4/21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@From</span> https://www.zhangjianbing.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello World!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Curl <a href="http://127.0.0.1:8080/hello" target="_blank" rel="noopener">http://127.0.0.1:8080/hello</a> 可以正常访问，可见，@SpringBootApplication注解并非一定要标注在启动类上面。</p>
</blockquote>
<h2 id="理解自动配置机制"><a href="#理解自动配置机制" class="headerlink" title="理解自动配置机制"></a>理解自动配置机制</h2><blockquote>
<p>在Spring Boot出现之前，Spring提供Bean生命周期管理和Spring编程模型，但是Spring无法自动装配被@Configuration标注的类，而Spring Boot添加了约定配置化导入@Configuration类的方式，这就是自动装配机制。</p>
</blockquote>
<p>自动装配类能够打包到外部的JAR文件中，并且将被Spring Boot装载，例如在spring-boot-autoconfigure-2.0.0.REALEASE.jar的META-INF文件夹下有一个文件，叫spring.factories，这也是Spring的工厂加载机制(SpringFactoriesLoader)，这个文件就是自动装配文件，随便点开一个类，它的类上都会标注@ConditionalOnClass或者@ConditionalOnMissingBean注解，顾名思义，当一个类标注@ConditionalOnClass时，当且仅当目标类存在于Class Path下的时候，才会装配它。@ConditionalOnMissingBean表示Class Path下没有这个类的时候，会去装配它。</p>
<blockquote>
<p>spring.factories文件属于Java Properties文件格式，配置注解@EnableAutoConfiguration是这个Properties的key，而自动装配的类是Value，注意，所有的自动装配的类都以xxxAutoConfiguration为后缀。</p>
</blockquote>
<h2 id="创建自动配置类"><a href="#创建自动配置类" class="headerlink" title="创建自动配置类"></a>创建自动配置类</h2><blockquote>
<p>在 Spring Framework 中就使用了 Spring 的工厂加载机制 <code>SpringFactoriesLoader</code> ，在 Spring Boot 中同样适用了这种方式来装配Bean，步骤如下：</p>
</blockquote>
<ul>
<li>在classpath路径(resource文件夹)下创建<code>META-INF/spring.factories</code> 文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration&#x3D;\</span><br><span class="line">com.zhangjianbing.autoconfig.configauto.HelloWorldAutoConfiguration</span><br></pre></td></tr></table></figure>

<blockquote>
<p>EnableAutoConfiguration作为Key，HelloWorldAutoConfiguration作为Value</p>
</blockquote>
<ul>
<li>EnableAutoConfiguration</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import</span>(value = &#123;User<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnSystem</span>(<span class="title">name</span> </span>= <span class="string">"user.name"</span>,value = <span class="string">"zhangjianbing"</span>) <span class="comment">// 条件装配</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>首先利用上面自定义的条件注解(@ConditionalOnSystem)判断是否注入，如果符合条件则利用@Import导入User类。</p>
</blockquote>
<ul>
<li>启动类BootStrap</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAutoConfiguration</span> <span class="comment">// 开启自动装配注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldAutoConfigurationBootStrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">new</span> SpringApplicationBuilder(HelloWorldAutoConfigurationBootStrap<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">web</span>(<span class="title">WebApplicationType</span>.<span class="title">NONE</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">run</span>(<span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从IOC容器中获取Import注入的User对象</span></span><br><span class="line">        User user = context.getBean(User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当条件注解 <code>@ConditionalOnSystem</code> 成立的时候，容器中会有User对象，可以获取到。如果不成立，则会报异常。当不想向容器中注入User对象的时候，可以将条件注解置为false。</p>
</blockquote>
</div><div class="tags"><a href="/tags/Boot/">Boot</a></div><div class="post-nav"><a class="pre" href="/concurrent/concurrent-volatile.html">理解volatile关键字</a><a class="next" href="/boot/boot-top.html">Spring Boot 2.0深度实践总览</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://yoursite.com/boot/boot-autoconfig.html';
    this.page.identifier = 'boot/boot-autoconfig.html';
    this.page.title = 'Spring Boot 2.0深度实践：理解自动装配';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//zhangjianbing.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//zhangjianbing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://zhangjianbing.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/algorithms/">algorithms</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/boot/">boot</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/">cloud</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/concurrent/">concurrent</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/designpattern/">designpattern</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/interview/">interview</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/zk/">zk</a><span class="category-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 16.43px;">算法</a> <a href="/tags/Boot/" style="font-size: 23.57px;">Boot</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 20.71px;">面试</a> <a href="/tags/Cloud/" style="font-size: 15px;">Cloud</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 25px;">并发编程</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">设计模式</a> <a href="/tags/Kafka/" style="font-size: 20.71px;">Kafka</a> <a href="/tags/%E7%B2%BE%E5%BD%A9%E7%94%9F%E6%B4%BB/" style="font-size: 22.14px;">精彩生活</a> <a href="/tags/Spring/" style="font-size: 17.86px;">Spring</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/zk/" style="font-size: 23.57px;">zk</a> <a href="/tags/MarkDown/" style="font-size: 15px;">MarkDown</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/interview/beanutils.html">你还在使用BeanUtils吗？</a></li><li class="post-list-item"><a class="post-list-link" href="/life/life-my2020.html">2020年</a></li><li class="post-list-item"><a class="post-list-link" href="/algorithms/algorithms-rsa.html">RSA非对称加密算法简述</a></li><li class="post-list-item"><a class="post-list-link" href="/boot/boot-ut-powermock.html">SpringBoot使用Powermockito单元测试</a></li><li class="post-list-item"><a class="post-list-link" href="/boot/boot-ut-mokito.html">SpringBoot使用Mockito单元测试</a></li><li class="post-list-item"><a class="post-list-link" href="/interview/interview-cyclicbarrier-countdownlatch.html">CyclicBarrier和CountDownLatch比较</a></li><li class="post-list-item"><a class="post-list-link" href="/designpattern/designpattern-strategy.html">设计模式之：策略模式</a></li><li class="post-list-item"><a class="post-list-link" href="/life/life-project-online.html">我们的项目上线了</a></li><li class="post-list-item"><a class="post-list-link" href="/designpattern/designpattern-template.html">设计模式之：模板方法模式</a></li><li class="post-list-item"><a class="post-list-link" href="/concurrent/concurrentprogram-cyclicbarrier.html">Java 并发编程系列之 (七)：CyclicBarrier 工具类</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//zhangjianbing.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.cnblogs.com/zhangjianbing/" title="在谷歌上百度" target="_blank">在谷歌上百度</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">在谷歌上百度.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>